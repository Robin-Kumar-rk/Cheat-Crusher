
# Cheat Crusher — TRAE SPEC


## 1. Short project summary

**Project:** Cheat Crusher (college mini-project) — Android student app (Kotlin + Jetpack Compose) + React web admin.

**Goal:** Replace Google Forms for in-class quizzes with an offline-first quiz app that reduces cheating by: disabling screenshots (`FLAG_SECURE`), preventing multiple attempts per device, requiring teacher-generated join-codes that control exact join windows, and enabling offline attempts with manual upload of responses.

**Important constraints:**
- No student authentication. Students join anonymously. Teacher creates quizzes on admin web portal and publishes a *quiz JSON* into Firestore.
- Quiz metadata and all questions are stored as a single JSON string in Firestore (downloadable by students using a short *download code*). After download, the app works offline (join validation is done offline using the downloaded JSON + device time checks).
- Uploading of responses requires network; submission is saved locally first and the student must press an Upload button to send to Firestore.
- Teachers can generate multiple join-codes per quiz (each join-code = `unlockPassword + startTime`). Join-codes are *not revocable* after distribution (teachers must clone/replace quiz if needed).

---

## 2. High-level flows

### Teacher / Admin (Web)
1. Teacher signs up / login (Firebase Auth email/password).
2. Teacher creates a quiz (questions, options, correct answers, weights, settings). When saved, the **entire quiz** is saved in Firestore as a single JSON string under `/quizzes/{quizId}.json`.
3. Teacher can clone an existing quiz to create a new quiz (questions copied, settings editable in new quiz).
4. Teacher can generate one or more **unlock passwords** and associated permitted `startTime` values (teacher picks each startTime when generating a join-code). These password + startTime pairs are included in the quiz JSON as `allowedJoinCodes` (see schema).
5. Teacher can also request an **answer-view password** (autogenerated) stored in quiz JSON. After teacher distributes this special password (manually), students can use it after submission to view correct answers locally.
6. Teacher gets a short **download code** to give to students (for example via WhatsApp). Students use this code in the app to download quiz JSON.
7. Teacher is warned at creation that responses will be automatically deleted after 7 days unless exported. Teacher may export CSV of responses from admin panel.

### Student (Android App)
1. Student installs the app, opens it, and uses the **Download Code** provided by teacher to fetch the quiz JSON from Firestore (requires network). The downloaded JSON is stored locally so the whole quiz can be attempted offline.
2. At quiz time, teacher provides a **Join Code** (sent by teacher; join code = `unlockPassword + startTime` format). The student enters this join code. App splits it into `unlockPassword` and `startTime`.
3. The app checks **offline** the downloaded JSON for the presence of `unlockPassword` in its `allowedJoinCodes`. If present and `currentDeviceTime` satisfies `startTime <= now <= startTime + latencyMinutes`, the quiz activates locally.
4. Student attempts the quiz (MSQ/MCQ only). Timer length is stored in the quiz JSON and enforced locally (auto-submit when timer expires).
5. Student taps **Submit**: an immutable local submission is created and stored on device. Student can still view marks locally after submission (correct answers are included in quiz JSON). Student must press **Upload** to send response to Firestore when network available. Upload is a one-time action per device per quiz: once uploaded, upload button disappears.
6. Pre-form fields (name, roll, email, section, etc.) are defined in quiz JSON by teacher. Students can fill these before joining (recommended) or before upload if they forgot. Upload is rejected if required fields are missing.

---

## 3. Key decisions made (explicit)

- **Quiz stored as JSON string** in Firestore: entire quiz document content (metadata, questions, allowed join-codes, passwords, answer-view password, latency, timer, pre-form config) is a JSON string field `rawJson`. This simplifies downloading a single object and guarantees offline capability.
- **Join-code logic is offline:** The `allowedJoinCodes` array included inside quiz JSON contains `{ unlockPassword, allowedStartTimes: [ISO8601 strings] }`. When the student enters a join code, the app splits unlockPassword and startTime, then verifies that `unlockPassword` exists in `allowedJoinCodes` and that `startTime` is one of the allowedStartTimes for that unlockPassword. This prevents students from inventing arbitrary start times that aren't pre-recorded in the JSON.
- **No student authentication**: anonymous usage. To enforce one response per device, the app uses a device identifier (ANDROID_ID or Firebase Installations ID) stored in the local submitted response and included in uploaded response. The app prevents multiple local attempts and prevents upload if a previous upload exists for that device + quiz.
- **Offline marking:** correct answers (for MCQ/MSQ) are included in the downloaded JSON so local scoring is possible and students can see marks immediately after local submission (even before upload). The answer-view password is a separate autogenerated password; teacher distributes it manually when ready.
- **No revocation of join codes** after generation because app uses only local data post-download.
- **Auto-delete policy:** teacher is warned and responses are deleted after 7 days unless teacher exported. The admin panel offers manual delete and CSV export.

---

## 4. Firestore layout (minimal)

- `/quizzes/{quizId}` document structure (primary fields):
```json
{
  "id": "quizId",
  "downloadCode": "shortCode123",
  "rawJson": "{...}",
  "createdBy": "teacherUid",
  "createdAt": "2025-11-01T10:00:00Z"
}
```

`rawJson` is a string containing JSON with the schema described below.

- `/responses/{responseId}` document structure:
```json
{
  "quizId": "quizId",
  "deviceId": "android_id_or_fid",
  "clientSubmittedAt": "2025-11-01T11:05:00Z",
  "serverUploadedAt": "2025-11-01T11:07:00Z",
  "preform": { "name": "", "roll": "", ... },
  "answers": [ { "qId": "...", "answer": ["opt1"] } ],
  "score": 10,
  "uploaded": true
}
```

> Export/CSV will be generated from `/responses` querying `quizId`.

---

## 5. `rawJson` quiz schema (example)

`rawJson` is a JSON string in this shape (teacher UI builds this):

```json
{
  "quizId": "Q-2025-001",
  "title": "Midterm Quiz",
  "description": "...",
  "downloadCode": "DL1234",
  "latencyMinutes": 15,
  "timerMinutes": 60,
  "preForm": {
    "fields": [
      { "key": "name", "label": "Name", "required": true },
      { "key": "roll", "label": "Roll No", "required": true },
      { "key": "email", "label": "Email", "required": false }
    ]
  },
  "questions": [
    { "id":"q1","type":"MCQ","text":"...","options":["A","B","C"],"correct":[0],"weight":2 },
    { "id":"q2","type":"MSQ","text":"...","options":["A","B","C","D"],"correct":[0,3],"weight":3 }
  ],
  "allowedJoinCodes": [
    {
      "unlockPassword":"PWD-ABC123",
      "allowedStartTimes": ["2025-11-09T10:00:00Z","2025-11-09T14:00:00Z"]
    }
  ],
  "answerViewPassword": "ANS-XX1",
  "autoDeleteDays": 7
}
```

**Notes:**
- `allowedJoinCodes` defines which unlock passwords are valid and which start times are permitted for each password. Teacher generates these pairs and distributes join-codes as `unlockPassword + startTime` to students. Example join-code string format could be `PWD-ABC123|2025-11-09T10:00:00Z`.
- `latencyMinutes` is the join latency: students may join if `startTime <= now <= startTime + latencyMinutes`.
- `timerMinutes` is total quiz duration after local activation.

---

## 6. Join-code verification logic (client/offline)

When student enters a join-code string, the app will:
1. Parse join-code into `{unlockPassword, startTime}`. Support a simple delimiter `|` (vertical bar). App should accept ISO8601 startTime.
2. Load the downloaded `rawJson` and parse it.
3. Find an entry in `allowedJoinCodes` where `unlockPassword` matches and `startTime` is present in that entry's `allowedStartTimes` array.
4. Check device clock `now` is in the inclusive window: `startTime <= now <= startTime + latencyMinutes`.
5. Check locally that a submission has NOT already been created/uploaded for this device for this `quizId` (prevent rejoin). If all checks pass, activate quiz locally.

**Security note:** Because the app works offline after download, *join-codes must be generated by the teacher and stored* in `rawJson` so students cannot invent valid start times that aren't pre-recorded in the JSON. This is why `allowedStartTimes` is stored for each unlockPassword.

---

## 7. Upload and local submission behavior

- **Local submission:** on tapping Submit, app creates an immutable local submission object (includes answers, `clientSubmittedAt`, preForm values, computed local score). Student can see marks locally.
- **Upload:** student presses **Upload** to send submission to Firestore `/responses`. If network not available, `Upload` remains visible and app will retry when user presses it and network is available. Once upload succeeds, `uploaded=true` and Upload button disappears.
- **Upload rules:** each device can upload only once per quiz. If a server-side duplicate detection finds another response from same `deviceId` for same `quizId`, uploader UI will show an error (reject upload).

---

## 8. Device uniqueness enforcement (client-side)

- Use Android `Settings.Secure.ANDROID_ID` or `FirebaseInstallations.getId()` as `deviceId`. Save local flag `hasSubmittedQuiz_quizId=true` after **local submission** and prevent further attempts.
- When uploading, include `deviceId` in `/responses` so admin can audit and server-side dedup rule (in admin export) can detect multiples. The app will also check server for existing uploads for same `deviceId` before allowing Upload (if online).

---

## 9. Pre-form (teacher-defined fields)

- Teacher picks which pre-form fields are required (name, roll, email, section, or custom keys).
- Student can fill pre-form before joining (recommended) or before upload. If required fields missing at upload time, app shows a blocking prompt to fill them.
- Admin export UI will offer a column selection; teacher selects which pre-form fields appear in CSV export.

---

## 10. Teacher cloning & immutability

- Once a quiz is created and published (saved to Firestore), the quiz `rawJson` is considered immutable; teacher can **clone** the quiz, edit questions in the clone, change settings, and generate new join-codes for the clone.
- Cloning copies questions and allows edits on the new quiz only.

---

## 11. Answer-view password

- When creating the quiz, admin can request an `answerViewPassword` (auto generated). This is stored in `rawJson`. After students complete and submit locally, teacher can distribute this password and students can input it in the app to toggle display of the correct answers locally for their submitted attempt.

---

## 12. Admin web panel features (minimum)

- Login/signup for teachers (Firebase Auth)
- Create quiz UI (build `rawJson`), upload quiz to `/quizzes/{quizId}` with a short `downloadCode` (human-friendly).
- Generate one or more `allowedJoinCodes` (unlockPassword + allowedStartTime entries) and store them in `rawJson`.
- Clone existing quizzes.
- Export responses CSV for a quiz. Allow teacher to select which pre-form fields to include as columns.
- Show warning banner about auto-delete 7 days after quiz end, and manual delete button.

---

## 13. Acceptance tests (developer checklist)

1. Admin creates quiz, saves to Firestore, and gets `downloadCode`.
2. Student downloads quiz JSON using `downloadCode` (app stores `rawJson` locally).
3. Teacher generates join-code `unlockPassword|startTime` (startTime in allowedStartTimes for that password).
4. Student enters join-code offline and app activates quiz if `now` in `[startTime, startTime+latency]` and `device` has not previously submitted.
5. Student completes quiz offline, taps Submit: local submission created and local score computed.
6. Student uploads response when network available; Firestore `/responses` contains expected fields including `deviceId`, `clientSubmittedAt`, `serverUploadedAt`.
7. Attempt to submit again from same device rejected by client (no local second submission) and server-side duplicate detection.
8. Teacher exports CSV; selected pre-form fields appear as chosen columns.

---

## 14. Files TRAE should create first (minimum viable)

Place these as first commit changes with short commit messages:

- `TRAE_SPEC.md` (this file) — commit message: `spec: add TRAE spec`
- `admin/` skeleton: `admin/src/App.js`, `admin/src/pages/CreateQuiz.js`, `admin/src/utils/firestore.js` — commit: `admin: init react admin`
- `android/` skeleton: `MainActivity.kt` (Compose entry), `DownloadQuizScreen.kt`, `EnterJoinCodeScreen.kt`, `QuizScreen.kt`, `SubmissionRepository.kt`, `LocalStore.kt` — commit: `android: init app skeleton`
- `firebase.rules` and `README.md` — commit: `infra: add rules and README`

---

## 15. Implementation notes for TRAE (agent instructions)

- Use Kotlin + Jetpack Compose, MVVM + Repository pattern. Keep code commented concisely.
- Use Room or simple file-storage for local `rawJson` and local submissions. Offline reliability is critical — prefer a small `LocalStore` wrapper that writes JSON files to app internal storage.
- Use `Settings.Secure.ANDROID_ID` as `deviceId`. If unavailable, use `FirebaseInstallations.getId()` as fallback.
- On `EnterJoinCodeScreen`, validate join code offline strictly against the `allowedJoinCodes` array inside `rawJson`.
- Do not implement server-side signature or HMAC for join-codes (not required because `allowedJoinCodes` reside in `rawJson` downloaded from the teacher-authoritative source).
- Make the UI minimal and clear: Download quiz → Pre-form → Enter Join Code → Quiz Timer/Questions → Submit → Upload.
- Provide `README-ANDROID.md` and `README-ADMIN.md` with Firebase setup steps (Firestore, hosting, enable email/password auth).

---

## 16. Last notes & conservative defaults

- If TRAE faces any ambiguous choices, prefer conservative, privacy-respecting defaults: require `preForm` fields if teacher marks them required, do not auto-upload, do not use camera, keep `rawJson` immutable after publish (cloning allowed).
- Keep commit messages short and provide a short acceptance checklist after each major feature commit.

---

_End of spec_
